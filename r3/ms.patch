From 04d4c2ab061dc378dd1144c0c303bead84ec25bc Mon Sep 17 00:00:00 2001
From: i l <il@il.com>
Date: Wed, 1 Oct 2025 12:00:32 -0400
Subject: [PATCH 04/12] ms

---
 config/Config-images.in                       |   3 +-
 feeds.conf.default                            |   8 +-
 include/rootfs.mk                             |   4 +
 include/target.mk                             |   2 +-
 package/base-files/Makefile                   |   8 +-
 package/base-files/files/bin/config_generate  |  13 +-
 package/base-files/image-config.in            |   4 +-
 package/firmware/linux-firmware/broadcom.mk   | 219 ++++++++++++++++++
 package/firmware/linux-firmware/realtek_bt.mk |   8 +
 .../patches/500-world-regd-5GHz.patch         |  53 +++++
 package/kernel/linux/modules/bluetooth.mk     |  11 +-
 .../patches/001-flow_offloading.patch         |   8 +
 package/network/utils/iwinfo/patches/01.patch | 122 ++++++++++
 scripts/projectsmirrors.json                  |   2 +
 .../bcm27xx/base-files/etc/board.d/02_network |   2 +-
 .../base-files/etc/init.d/resize-rootfs       |   9 +
 .../base-files/etc/rc.d/S22resize-rootfs      |   1 +
 .../base-files/usr/bin/resize-rootfs.sh       |  39 ++++
 target/linux/bcm27xx/image/Makefile           |   2 +
 target/linux/bcm27xx/image/config.txt         |   5 +
 target/linux/bcm27xx/image/distroconfig.txt   |  10 +
 21 files changed, 505 insertions(+), 28 deletions(-)
 create mode 100644 package/firmware/linux-firmware/realtek_bt.mk
 create mode 100644 package/network/config/firewall4/patches/001-flow_offloading.patch
 create mode 100644 package/network/utils/iwinfo/patches/01.patch
 create mode 100755 target/linux/bcm27xx/base-files/etc/init.d/resize-rootfs
 create mode 100755 target/linux/bcm27xx/base-files/etc/rc.d/S22resize-rootfs
 create mode 100755 target/linux/bcm27xx/base-files/usr/bin/resize-rootfs.sh

diff --git a/config/Config-images.in b/config/Config-images.in
index 208c4838d1..4aa4df1196 100644
--- a/config/Config-images.in
+++ b/config/Config-images.in
@@ -144,7 +144,6 @@ menu "Target Images"
 		config TARGET_EXT4_JOURNAL
 			bool "Create a journaling filesystem"
 			depends on TARGET_ROOTFS_EXT4FS
-			default y
 			help
 			  Create an ext4 filesystem with a journal.
 
@@ -336,7 +335,7 @@ menu "Target Images"
 		depends on USES_ROOTFS_PART || TARGET_ROOTFS_EXT4FS
 		default 232 if TARGET_loongarch64
 		default 448 if TARGET_mediatek
-		default 104
+		default 1040
 		help
 		  Select the root filesystem partition size.
 
diff --git a/include/rootfs.mk b/include/rootfs.mk
index 26f249d818..29d4fa8ef2 100644
--- a/include/rootfs.mk
+++ b/include/rootfs.mk
@@ -74,6 +74,7 @@ define prepare_rootfs
 	fi)
 	@mkdir -p $(1)/etc/rc.d
 	@mkdir -p $(1)/var/lock
+        @mkdir -p $(1)/www/repo
 	@( \
 		cd $(1); \
 		if [ -n "$(CONFIG_USE_APK)" ]; then \
@@ -119,6 +120,9 @@ define prepare_rootfs
 		$(1)/usr/lib/opkg/info/*.postinst* \
 		$(1)/usr/lib/opkg/lists/* \
 		$(1)/var/lock/*.lock
+        @(      $(MAKE) package/index; \
+                $(CP) $(TOPDIR)/bin/targets/$(BOARD)/$(SUBTARGET)/packages $(1)/www/repo/packages; \
+        )
 	$(call clean_ipkg,$(1))
 	$(call mklibs,$(1))
 	$(if $(SOURCE_DATE_EPOCH),find $(1)/ -mindepth 1 -execdir touch -hcd "@$(SOURCE_DATE_EPOCH)" "{}" +)
diff --git a/include/target.mk b/include/target.mk
index fdfda81159..35901a61e2 100644
--- a/include/target.mk
+++ b/include/target.mk
@@ -50,7 +50,7 @@ DEFAULT_PACKAGES.nas:=\
 # @brief Default packages for @DEVICE_TYPE router.
 ##
 DEFAULT_PACKAGES.router:=\
-	dnsmasq \
+	dnsmasq-full \
 	firewall4 \
 	nftables \
 	kmod-nft-offload \
diff --git a/package/base-files/Makefile b/package/base-files/Makefile
index 693d259ee4..4309b9c1e2 100644
--- a/package/base-files/Makefile
+++ b/package/base-files/Makefile
@@ -87,7 +87,7 @@ define ImageConfigOptions
 	echo 'pi_init_cmd=$(if $(CONFIG_TARGET_INIT_CMD),$(CONFIG_TARGET_INIT_CMD),"/sbin/init")' >>$(1)/lib/preinit/00_preinit.conf
 	echo 'pi_init_suppress_stderr="$(CONFIG_TARGET_INIT_SUPPRESS_STDERR)"' >>$(1)/lib/preinit/00_preinit.conf
 	echo 'pi_ifname=$(if $(CONFIG_TARGET_PREINIT_IFNAME),$(CONFIG_TARGET_PREINIT_IFNAME),"")' >>$(1)/lib/preinit/00_preinit.conf
-	echo 'pi_ip=$(if $(CONFIG_TARGET_PREINIT_IP),$(CONFIG_TARGET_PREINIT_IP),"192.168.1.1")' >>$(1)/lib/preinit/00_preinit.conf
+	echo 'pi_ip=$(if $(CONFIG_TARGET_PREINIT_IP),$(CONFIG_TARGET_PREINIT_IP),"192.168.10.1")' >>$(1)/lib/preinit/00_preinit.conf
 	echo 'pi_netmask=$(if $(CONFIG_TARGET_PREINIT_NETMASK),$(CONFIG_TARGET_PREINIT_NETMASK),"255.255.255.0")' >>$(1)/lib/preinit/00_preinit.conf
 	echo 'pi_broadcast=$(if $(CONFIG_TARGET_PREINIT_BROADCAST),$(CONFIG_TARGET_PREINIT_BROADCAST),"192.168.1.255")' >>$(1)/lib/preinit/00_preinit.conf
 	echo 'pi_preinit_net_messages="$(CONFIG_TARGET_PREINIT_SHOW_NETMSG)"' >>$(1)/lib/preinit/00_preinit.conf
@@ -100,7 +100,7 @@ ifeq ($(CONFIG_TARGET_DEFAULT_LAN_IP_FROM_PREINIT),y)
 	echo 'board_config_update' >>$(1)/etc/board.d/99-lan-ip
 	echo 'json_select network' >>$(1)/etc/board.d/99-lan-ip
 	echo 'json_select lan' >>$(1)/etc/board.d/99-lan-ip
-	echo 'json_add_string ipaddr $(if $(CONFIG_TARGET_PREINIT_IP),$(CONFIG_TARGET_PREINIT_IP),"192.168.1.1")' >>$(1)/etc/board.d/99-lan-ip
+	echo 'json_add_string ipaddr $(if $(CONFIG_TARGET_PREINIT_IP),$(CONFIG_TARGET_PREINIT_IP),"192.168.10.1")' >>$(1)/etc/board.d/99-lan-ip
 	echo 'json_add_string netmask $(if $(CONFIG_TARGET_PREINIT_NETMASK),$(CONFIG_TARGET_PREINIT_NETMASK),"255.255.255.0")' >>$(1)/etc/board.d/99-lan-ip
 	echo 'json_select ..' >>$(1)/etc/board.d/99-lan-ip
 	echo 'json_select ..' >>$(1)/etc/board.d/99-lan-ip
@@ -121,12 +121,10 @@ endef
 Build/Compile = $(Build/Compile/Default)
 
 ifneq ($(CONFIG_USE_APK),)
-ifndef CONFIG_BUILDBOT
   define Package/base-files/install-key
 	mkdir -p $(1)/etc/apk/keys
 	$(CP) $(BUILD_KEY_APK_PUB) $(1)/etc/apk/keys/
   endef
-endif
 else
 ifdef CONFIG_SIGNED_PACKAGES
   define Build/Configure
@@ -138,14 +136,12 @@ ifdef CONFIG_SIGNED_PACKAGES
 
   endef
 
-ifndef CONFIG_BUILDBOT
   define Package/base-files/install-key
 	mkdir -p $(1)/etc/opkg/keys
 	$(CP) $(BUILD_KEY).pub $(1)/etc/opkg/keys/`$(STAGING_DIR_HOST)/bin/usign -F -p $(BUILD_KEY).pub`
   endef
 endif
 endif
-endif
 
 ifeq ($(CONFIG_NAND_SUPPORT),)
   define Package/base-files/nand-support
diff --git a/package/base-files/files/bin/config_generate b/package/base-files/files/bin/config_generate
index 7507aa612c..c54cfb6267 100755
--- a/package/base-files/files/bin/config_generate
+++ b/package/base-files/files/bin/config_generate
@@ -3,7 +3,6 @@
 CFG=/etc/board.json
 
 . /usr/share/libubox/jshn.sh
-. /lib/functions/ipv4.sh
 
 [ -s $CFG ] || /bin/board_detect || exit 1
 [ -s /etc/config/network -a -s /etc/config/system ] && exit 0
@@ -43,7 +42,8 @@ generate_static_network() {
 		set network.loopback='interface'
 		set network.loopback.device='lo'
 		set network.loopback.proto='static'
-		add_list network.loopback.ipaddr='127.0.0.1/8'
+		set network.loopback.ipaddr='127.0.0.1'
+		set network.loopback.netmask='255.0.0.0'
 	EOF
 		[ -e /proc/sys/net/ipv6 ] && {
 			uci -q batch <<-EOF
@@ -160,19 +160,18 @@ generate_network() {
 
 	case "$protocol" in
 		static)
-			local ipad netm prefix
+			local ipad
 			case "$1" in
-				lan) ipad=${ipaddr:-"192.168.1.1"} ;;
+				lan) ipad=${ipaddr:-"192.168.10.1"} ;;
 				*) ipad=${ipaddr:-"192.168.$((addr_offset++)).1"} ;;
 			esac
 
 			netm=${netmask:-"255.255.255.0"}
-			str2ip netm "$netm"
-			netmask2prefix prefix "$netm"
 
 			uci -q batch <<-EOF
 				set network.$1.proto='static'
-				add_list network.$1.ipaddr='$ipad/$prefix'
+				set network.$1.ipaddr='$ipad'
+				set network.$1.netmask='$netm'
 			EOF
 			[ -e /proc/sys/net/ipv6 ] && uci set network.$1.ip6assign='60'
 		;;
diff --git a/package/base-files/image-config.in b/package/base-files/image-config.in
index 67ef4d415a..a8beb17acd 100644
--- a/package/base-files/image-config.in
+++ b/package/base-files/image-config.in
@@ -83,7 +83,7 @@ config TARGET_PREINIT_IFNAME
 config TARGET_PREINIT_IP
 	string
 	prompt "IP address for preinit network messages" if PREINITOPT
-	default "192.168.1.1"
+	default "192.168.10.1"
 	help
 		IP address used to configure interface for preinit network
 		messages, including failsafe messages
@@ -99,7 +99,7 @@ config TARGET_PREINIT_NETMASK
 config TARGET_PREINIT_BROADCAST
 	string
 	prompt "Broadcast address for preinit network messages" if PREINITOPT
-	default "192.168.1.255"
+	default "192.168.10.255"
 	help
 		Broadcast address to which to send preinit network messages, as
 		as failsafe messages
diff --git a/package/firmware/linux-firmware/broadcom.mk b/package/firmware/linux-firmware/broadcom.mk
index c37edf211c..2140ae977c 100644
--- a/package/firmware/linux-firmware/broadcom.mk
+++ b/package/firmware/linux-firmware/broadcom.mk
@@ -212,3 +212,222 @@ define Package/bnx2x-firmware/install
 		$(1)/lib/firmware/bnx2x/
 endef
 $(eval $(call BuildPackage,bnx2x-firmware))
+
+
+## Broadcom BRCM43456
+
+BRCMFMAC_43456_URL:=https://raw.githubusercontent.com/RPi-Distro/firmware-nonfree/bookworm/debian/config/brcm80211/brcm/
+
+define Download/brcmfmac43456-sdio.bin
+  FILE:=brcmfmac43456-sdio.bin
+  URL:=$(BRCMFMAC_43456_URL)
+  HASH:=ddf83f2100885b166be52d21c8966db164fdd4e1d816aca2acc67ee9cc28d726
+endef
+
+define Download/brcmfmac43456-sdio.clm_blob
+  FILE:=brcmfmac43456-sdio.clm_blob
+  URL:=$(BRCMFMAC_43456_URL)
+  HASH:=2dbd7d22fc9af0eb560ceab45b19646d211bc7b34a1dd00c6bfac5dd6ba25e8a
+endef
+
+define Download/brcmfmac43456-sdio.txt
+  FILE:=brcmfmac43456-sdio.txt
+  URL:=$(BRCMFMAC_43456_URL)
+  HASH:=44e0bb322dc1f39a4b0a89f30ffdd28bc93f7d7aaf534d06d229fe56f6198194
+endef
+
+$(eval $(call Download,brcmfmac43456-sdio.bin))
+$(eval $(call Download,brcmfmac43456-sdio.clm_blob))
+$(eval $(call Download,brcmfmac43456-sdio.txt))
+
+Package/brcmfmac-firmware-43456-rockpi-4 = $(call Package/firmware-default,Broadcom Rock Pi 4 firmware)
+define Package/brcmfmac-firmware-43456-rockpi-4/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/brcmfmac43456-sdio.bin \
+		$(1)/lib/firmware/brcm/brcmfmac43456-sdio.radxa,rockpi4a.bin
+	$(INSTALL_DATA) \
+		$(DL_DIR)/brcmfmac43456-sdio.clm_blob \
+		$(1)/lib/firmware/brcm/brcmfmac43456-sdio.radxa,rockpi4a.clm_blob
+	$(INSTALL_DATA) \
+		$(DL_DIR)/brcmfmac43456-sdio.txt \
+		$(1)/lib/firmware/brcm/brcmfmac43456-sdio.radxa,rockpi4a.txt
+endef
+$(eval $(call BuildPackage,brcmfmac-firmware-43456-rockpi-4))
+
+## Broadcom NanoPi M4 firmware
+
+BRCMFMAC_4356_URL:=https://raw.githubusercontent.com/armbian/firmware/master/brcm/
+
+define Download/brcmfmac4356-sdio.bin
+  FILE:=brcmfmac4356-sdio.bin
+  URL:=$(BRCMFMAC_4356_URL)
+  HASH:=cc689fc1b39bd3d1655eff9fcfac60a3bf73fb6a45e77fdbab1e762aeeecf34e
+endef
+
+define Download/brcmfmac4356-sdio.clm_blob
+  FILE:=brcmfmac4356-sdio.clm_blob
+  URL:=$(BRCMFMAC_4356_URL)
+  HASH:=e048470d674de8865c30521138af248e5f96a9878ac73b707d834698cbf9a08a
+endef
+
+define Download/brcmfmac4356-sdio.txt
+  FILE:=brcmfmac4356-sdio.txt
+  URL:=$(BRCMFMAC_4356_URL)
+  HASH:=81efd86f47fac54596d3c614872b2997ed0079303136e4c675a8eaa1a39db120
+endef
+
+$(eval $(call Download,brcmfmac4356-sdio.bin))
+$(eval $(call Download,brcmfmac4356-sdio.clm_blob))
+$(eval $(call Download,brcmfmac4356-sdio.txt))
+
+Package/brcmfmac-firmware-4356-nanopi-m4 = $(call Package/firmware-default,Broadcom NanoPi M4 firmware)
+define Package/brcmfmac-firmware-4356-nanopi-m4/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(PKG_BUILD_DIR)/cypress/cyfmac4356-sdio.bin \
+		$(1)/lib/firmware/brcm/brcmfmac4356-sdio.friendlyarm,nanopi-m4.bin
+	$(INSTALL_DATA) \
+		$(PKG_BUILD_DIR)/cypress/cyfmac4356-sdio.clm_blob \
+		$(1)/lib/firmware/brcm/brcmfmac4356-sdio.friendlyarm,nanopi-m4.clm_blob
+	$(INSTALL_DATA) \
+		$(PKG_BUILD_DIR)/brcm/brcmfmac4356-sdio.AP6356S.txt \
+		$(1)/lib/firmware/brcm/brcmfmac4356-sdio.friendlyarm,nanopi-m4.txt
+endef
+$(eval $(call BuildPackage,brcmfmac-firmware-4356-nanopi-m4))
+
+## Broadcom AP6255 firmware
+
+AP_6255_URL:=https://raw.githubusercontent.com/Infineon/ifx-linux-firmware/refs/heads/master/firmware/
+
+##define Download/cyfmac43455-sdio-minimal.bin
+##  FILE:=cyfmac43455-sdio-minimal.bin
+##  URL:=$(AP_6255_URL)
+##  HASH:=3075cb0bdc4b28ed4f08e01b1a216d0ebc70f4022d9d3272a4a43b3c90456e60
+##endef
+
+define Download/cyfmac43455-sdio.bin
+  FILE:=cyfmac43455-sdio.bin
+  URL:=$(AP_6255_URL)
+  HASH:=eaff8d2b6d2501bb5c477ba343900c7487af915898eac13bc91b33b1285dadce
+endef
+
+define Download/cyfmac43455-sdio.clm_blob
+  FILE:=cyfmac43455-sdio.clm_blob
+  URL:=$(AP_6255_URL)
+  HASH:=8fbe9fc2952e2fbab062a142c1ea3e261cd74604761e12f304781b911df4a328
+endef
+
+##$(eval $(call Download,cyfmac43455-sdio-minimal.bin))
+$(eval $(call Download,cyfmac43455-sdio.bin))
+$(eval $(call Download,cyfmac43455-sdio.clm_blob))
+
+Package/brcmfmac-firmware-ap6255-hugsun-x99 = $(call Package/firmware-default,Broadcom hugsun x99 firmware)
+define Package/brcmfmac-firmware-ap6255-hugsun-x99/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/cyfmac43455-sdio.bin \
+		$(1)/lib/firmware/brcm/brcmfmac43455-sdio.hugsun,x99.bin
+	$(INSTALL_DATA) \
+		$(DL_DIR)/cyfmac43455-sdio.clm_blob \
+		$(1)/lib/firmware/brcm/brcmfmac43455-sdio.hugsun,x99.clm_blob
+	$(INSTALL_DATA) \
+		$(PKG_BUILD_DIR)/brcm/brcmfmac43455-sdio.acepc-t8.txt \
+		$(1)/lib/firmware/brcm/brcmfmac43455-sdio.hugsun,x99.txt
+endef
+$(eval $(call BuildPackage,brcmfmac-firmware-ap6255-hugsun-x99))
+
+
+## Broadcom BRCMBCM43430/BCM4345
+
+BRCMFMAC_434_URL:=https://github.com/RPi-Distro/bluez-firmware/raw/refs/heads/bookworm/debian/firmware/broadcom/
+
+define Download/BCM4343A2.hcd
+  FILE:=BCM4343A2.hcd
+  URL:=$(BRCMFMAC_434_URL)
+  HASH:=5f7fb0a863f9ee8874e4ad37ccc69abbc751fdc0257cb3fdd0ba0e89378ff76a
+endef
+
+define Download/BCM4345C0.hcd
+  FILE:=BCM4345C0.hcd
+  URL:=$(BRCMFMAC_434_URL)
+  HASH:=51c45e77ddad91a19e96dc8fb75295b2087c279940df2634b23baf71b6dea42c
+endef
+
+define Download/BCM4345C5.hcd
+  FILE:=BCM4345C5.hcd
+  URL:=$(BRCMFMAC_434_URL)
+  HASH:=fb9f4ec2df5301bd35f416384e103c012c5983024c49aa72fbbaf90177512caa
+endef
+
+define Download/BCM43430A1.hcd
+  FILE:=BCM43430A1.hcd
+  URL:=$(BRCMFMAC_434_URL)
+  HASH:=c096ad4a5c3f06ed7d69eba246bf89ada9acba64a5b6f51b1e9c12f99bb1e1a7
+endef
+
+define Download/BCM43430B0.hcd
+  FILE:=BCM43430B0.hcd
+  URL:=$(BRCMFMAC_434_URL)
+  HASH:=338c2c6631131f516bfc7e64ef0872bd0402e1f98ef9d0c900eef0c814d90a25
+endef
+
+$(eval $(call Download,BCM4343A2.hcd))
+$(eval $(call Download,BCM4345C0.hcd))
+$(eval $(call Download,BCM4345C5.hcd))
+$(eval $(call Download,BCM43430A1.hcd))
+$(eval $(call Download,BCM43430B0.hcd))
+
+Package/brcmfmac-sdio-firmware-4343-bt = $(call Package/firmware-default,CYW4343 BT firmware and patch RAM)
+define Package/brcmfmac-sdio-firmware-4343-bt/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM4343A2.hcd \
+		$(1)/lib/firmware/brcm/BCM4343A2.hcd
+endef
+$(eval $(call BuildPackage,brcmfmac-sdio-firmware-4343-bt))
+
+Package/brcmfmac-sdio-firmware-4345-bt = $(call Package/firmware-default,CYW4345 BT firmware and patch RAM)
+define Package/brcmfmac-sdio-firmware-4345-bt/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM4345C0.hcd \
+		$(1)/lib/firmware/brcm/BCM4345C0.hcd
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM4345C5.hcd \
+		$(1)/lib/firmware/brcm/BCM4345C5.hcd
+endef
+$(eval $(call BuildPackage,brcmfmac-sdio-firmware-4345-bt))
+
+Package/brcmfmac-sdio-firmware-43430-bt = $(call Package/firmware-default,CYW43430 BT firmware and patch RAM)
+define Package/brcmfmac-sdio-firmware-43430-bt/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM43430A1.hcd \
+		$(1)/lib/firmware/brcm/BCM43430A1.hcd
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM43430B0.hcd \
+		$(1)/lib/firmware/brcm/BCM43430B0.hcd
+endef
+$(eval $(call BuildPackage,brcmfmac-sdio-firmware-43430-bt))
+
+## Broadcom BCM4356A2
+
+BRCMFMAC_4356A2_URL:=https://github.com/LibreELEC/brcmfmac_sdio-firmware/raw/refs/heads/master/
+
+define Download/BCM4356A2.hcd
+  FILE:=BCM4356A2.hcd
+  URL:=$(BRCMFMAC_4356A2_URL)
+  HASH:=f1daa6ab28699b72c8e47a34f43c095941c9aa542d0a5f4b55baebc5fd1aae99
+endef
+
+$(eval $(call Download,BCM4356A2.hcd))
+
+Package/brcmfmac-sdio-firmware-4356A2-bt = $(call Package/firmware-default,BCM4356A2 BT firmware and patch RAM)
+define Package/brcmfmac-sdio-firmware-4356A2-bt/install
+	$(INSTALL_DIR) $(1)/lib/firmware/brcm
+	$(INSTALL_DATA) \
+		$(DL_DIR)/BCM4356A2.hcd \
+		$(1)/lib/firmware/brcm/BCM4356A2.hcd
+endef
+$(eval $(call BuildPackage,brcmfmac-sdio-firmware-4356A2-bt))
diff --git a/package/firmware/linux-firmware/realtek_bt.mk b/package/firmware/linux-firmware/realtek_bt.mk
new file mode 100644
index 0000000000..eb8aa87c7d
--- /dev/null
+++ b/package/firmware/linux-firmware/realtek_bt.mk
@@ -0,0 +1,8 @@
+Package/realtek-bluetooth-firmware = $(call Package/firmware-default,RealTek bluetooth firmware)
+define Package/realtek-bluetooth-firmware/install
+	$(INSTALL_DIR) $(1)/lib/firmware/rtl_bt
+	$(CP) \
+		$(PKG_BUILD_DIR)/rtl_bt/* \
+		$(1)/lib/firmware/rtl_bt
+endef
+$(eval $(call BuildPackage,realtek-bluetooth-firmware))
diff --git a/package/firmware/wireless-regdb/patches/500-world-regd-5GHz.patch b/package/firmware/wireless-regdb/patches/500-world-regd-5GHz.patch
index 3f6d4c7e8d..d095c2e001 100644
--- a/package/firmware/wireless-regdb/patches/500-world-regd-5GHz.patch
+++ b/package/firmware/wireless-regdb/patches/500-world-regd-5GHz.patch
@@ -14,3 +14,56 @@ Signed-off-by: Felix Fietkau <nbd@nbd.name>
  	# Channel 52 - 64
  	(5250 - 5330 @ 80), (20), NO-IR, DFS, AUTO-BW
  	# Channel 100 - 144
+@@ -106,12 +106,10 @@ country AN: DFS-ETSI
+ # Source:
+ # https://www.boletinoficial.gob.ar/detalleAviso/primera/287126/20230524
+ country AR: DFS-FCC
+-	(2402 - 2482 @ 40), (20)
+-	(5170 - 5250 @ 80), (17), AUTO-BW
+-	(5250 - 5330 @ 80), (24), DFS, AUTO-BW
+-	(5490 - 5730 @ 160), (24), DFS
+-	(5735 - 5835 @ 80), (30)
+-	(5925 - 7125 @ 320), (12), NO-OUTDOOR
++	(2402 - 2482 @ 40), (30)
++	(5170 - 5330 @ 160), (30)
++	(5490 - 5835 @ 160), (30)
++	(5925 - 7125 @ 320), (12), AUTO-BW
+ 
+ country AS: DFS-FCC
+ 	(2402 - 2472 @ 40), (30)
+@@ -446,9 +444,8 @@ country CL: DFS-JP
+ # https://www.miit.gov.cn/cms_files/filemanager/1226211233/attach/20236/d1dc19424d5a4cfe90d631adeee8dd58.pdf
+ # Note: The transmit power for 5250-5350MHz bands can be raised by 3dBm when TPC is implemented
+ country CN: DFS-FCC
+-	(2400 - 2483.5 @ 40), (20)
+-	(5150 - 5250 @ 80), (23), NO-OUTDOOR, AUTO-BW
+-	(5250 - 5350 @ 80), (20), NO-OUTDOOR, DFS, AUTO-BW
++	(2400 - 2483.5 @ 40), (30)
++	(5150 - 5350 @ 160), (30)
+ 	(5725 - 5850 @ 80), (33)
+ 	# 60 GHz band channels 1,4: 28dBm, channels 2,3: 44dBm
+ 	# ref: http://www.miit.gov.cn/n11293472/n11505629/n11506593/n11960250/n11960606/n11960700/n12330791.files/n12330790.pdf
+@@ -2007,20 +2004,18 @@ country US: DFS-FCC
+ 	(920 - 928 @ 8), (30)
+ 	(2400 - 2472 @ 40), (30)
+ 	# 5.15 ~ 5.25 GHz: 30 dBm for master mode, 23 dBm for clients
+-	(5150 - 5250 @ 80), (23), AUTO-BW
+-	(5250 - 5350 @ 80), (24), DFS, AUTO-BW
++	(5150 - 5350 @ 160), (30)
+ 	# This range ends at 5725 MHz, but channel 144 extends to 5730 MHz.
+ 	# Since 5725 ~ 5730 MHz belongs to the next range which has looser
+ 	# requirements, we can extend the range by 5 MHz to make the kernel
+ 	# happy and be able to use channel 144.
+-	(5470 - 5730 @ 160), (24), DFS
+-	(5730 - 5850 @ 80), (30), AUTO-BW
++	(5470 - 5850 @ 160), (30)
+ 	# https://www.federalregister.gov/documents/2021/05/03/2021-08802/use-of-the-5850-5925-ghz-band
+ 	# max. 33 dBm AP @ 20MHz, 36 dBm AP @ 40Mhz+, 6 dB less for clients
+ 	(5850 - 5895 @ 40), (27), NO-OUTDOOR, AUTO-BW, NO-IR
+ 	# 6g band
+ 	# https://www.federalregister.gov/documents/2020/05/26/2020-11236/unlicensed-use-of-the-6ghz-band
+-	(5925 - 7125 @ 320), (12), NO-OUTDOOR, NO-IR
++	(5925 - 7125 @ 320), (12), AUTO-BW
+ 	# 60g band
+ 	# reference: section IV-D https://docs.fcc.gov/public/attachments/FCC-16-89A1.pdf
+ 	# channels 1-6 EIRP=40dBm(43dBm peak)
diff --git a/package/kernel/linux/modules/bluetooth.mk b/package/kernel/linux/modules/bluetooth.mk
index 3e6b38a88c..352c415f0b 100644
--- a/package/kernel/linux/modules/bluetooth.mk
+++ b/package/kernel/linux/modules/bluetooth.mk
@@ -10,7 +10,7 @@ BLUETOOTH_MENU:=Bluetooth Support
 define KernelPackage/bluetooth
   SUBMENU:=$(BLUETOOTH_MENU)
   TITLE:=Bluetooth support
-  DEPENDS:=+kmod-crypto-hash +kmod-crypto-ecb +kmod-lib-crc16 +kmod-hid +kmod-crypto-cmac +kmod-regmap-core +kmod-crypto-ecdh
+  DEPENDS:=+kmod-crypto-hash +kmod-crypto-ecb +kmod-lib-crc16 +kmod-hid +kmod-crypto-cmac +kmod-regmap-core +kmod-crypto-ecdh +kmod-crypto-hmac +kmod-crypto-sha3 +kmod-crypto-sha512 +kmod-crypto-rng
   KCONFIG:= \
 	CONFIG_BT \
 	CONFIG_BT_BREDR=y \
@@ -38,10 +38,10 @@ $(eval $(call KernelPackage,bluetooth))
 define KernelPackage/hci-uart
   SUBMENU:=$(BLUETOOTH_MENU)
   TITLE:=Bluetooth HCI UART support
-  DEPENDS:=+kmod-bluetooth
+  DEPENDS:=+kmod-bluetooth +kmod-btusb
   KCONFIG:= \
 	CONFIG_BT_HCIUART \
-	CONFIG_BT_HCIUART_BCM=n \
+	CONFIG_BT_HCIUART_BCM=y \
 	CONFIG_BT_HCIUART_INTEL=n \
 	CONFIG_BT_HCIUART_H4 \
 	CONFIG_BT_HCIUART_NOKIA=n
@@ -63,13 +63,14 @@ define KernelPackage/btusb
   DEPENDS:=@USB_SUPPORT +kmod-usb-core +kmod-bluetooth +kmod-btmtk
   KCONFIG:= \
 	CONFIG_BT_HCIBTUSB \
-	CONFIG_BT_HCIBTUSB_BCM=n \
+	CONFIG_BT_HCIBTUSB_BCM=y \
 	CONFIG_BT_HCIBTUSB_MTK=y \
 	CONFIG_BT_HCIBTUSB_RTL=y
   FILES:= \
 	$(LINUX_DIR)/drivers/bluetooth/btusb.ko \
 	$(LINUX_DIR)/drivers/bluetooth/btintel.ko \
-	$(LINUX_DIR)/drivers/bluetooth/btrtl.ko
+	$(LINUX_DIR)/drivers/bluetooth/btrtl.ko \
+	$(LINUX_DIR)/drivers/bluetooth/btbcm.ko
   AUTOLOAD:=$(call AutoProbe,btusb)
 endef
 
diff --git a/package/network/config/firewall4/patches/001-flow_offloading.patch b/package/network/config/firewall4/patches/001-flow_offloading.patch
new file mode 100644
index 0000000000..0833ce391e
--- /dev/null
+++ b/package/network/config/firewall4/patches/001-flow_offloading.patch
@@ -0,0 +1,8 @@
+--- a/root/etc/config/firewall
++++ b/root/etc/config/firewall
+@@ -1,4 +1,5 @@
+ config defaults
++	option flow_offloading	1
+ 	option syn_flood	1
+ 	option input		REJECT
+ 	option output		ACCEPT
diff --git a/package/network/utils/iwinfo/patches/01.patch b/package/network/utils/iwinfo/patches/01.patch
new file mode 100644
index 0000000000..496eda3421
--- /dev/null
+++ b/package/network/utils/iwinfo/patches/01.patch
@@ -0,0 +1,122 @@
+--- a/devices.txt
++++ b/devices.txt
+@@ -246,6 +246,119 @@
+ # rtl8xxxu/rtl8xxxu_core.c
+ 0x0000 0x0000 0x0bda 0x8176    0      0  "Realtek" "RTL8188CU"
+ 0x0000 0x0000 0x0bda 0xf179    0      0  "Realtek" "RTL8188FTV"
++# rtw88/rtw8723du.c
++0x0000 0x0000 0x7392 0xd611    0      0  "Realtek" "RTL8723DU" /* Edimax EW-7611ULB V2 */
++# rtw88/rtw8812au.c
++0x0000 0x0000 0x0409 0x0408    0      0  "Realtek" "RTL8812AU" /* NEC */
++0x0000 0x0000 0x0411 0x025d    0      0  "Realtek" "RTL8812AU" /* Buffalo */
++0x0000 0x0000 0x04bb 0x0952    0      0  "Realtek" "RTL8812AU" /* I-O DATA */
++0x0000 0x0000 0x050d 0x1106    0      0  "Realtek" "RTL8812AU" /* Belkin */
++0x0000 0x0000 0x050d 0x1109    0      0  "Realtek" "RTL8812AU" /* Belkin */
++0x0000 0x0000 0x0586 0x3426    0      0  "Realtek" "RTL8812AU" /* ZyXEL */
++0x0000 0x0000 0x0789 0x016e    0      0  "Realtek" "RTL8812AU" /* Logitec */
++0x0000 0x0000 0x07b8 0x8812    0      0  "Realtek" "RTL8812AU" /* Abocom */
++0x0000 0x0000 0x0846 0x9051    0      0  "Realtek" "RTL8812AU" /* Netgear */
++0x0000 0x0000 0x0b05 0x17d2    0      0  "Realtek" "RTL8812AU" /* ASUS */
++0x0000 0x0000 0x0df6 0x0074    0      0  "Realtek" "RTL8812AU" /* Sitecom */
++0x0000 0x0000 0x0e66 0x0022    0      0  "Realtek" "RTL8812AU" /* Hawking */
++0x0000 0x0000 0x1058 0x0632    0      0  "Realtek" "RTL8812AU" /* WD */
++0x0000 0x0000 0x13b1 0x003f    0      0  "Realtek" "RTL8812AU" /* Linksys */
++0x0000 0x0000 0x148f 0x9097    0      0  "Realtek" "RTL8812AU" /* Amped Wireless */
++0x0000 0x0000 0x1740 0x0100    0      0  "Realtek" "RTL8812AU" /* EnGenius */
++0x0000 0x0000 0x2001 0x330e    0      0  "Realtek" "RTL8812AU" /* D-Link */
++0x0000 0x0000 0x2001 0x3313    0      0  "Realtek" "RTL8812AU" /* D-Link */
++0x0000 0x0000 0x2001 0x3315    0      0  "Realtek" "RTL8812AU" /* D-Link */
++0x0000 0x0000 0x2001 0x3316    0      0  "Realtek" "RTL8812AU" /* D-Link */
++0x0000 0x0000 0x2019 0xab30    0      0  "Realtek" "RTL8812AU" /* Planex */
++0x0000 0x0000 0x20f4 0x805b    0      0  "Realtek" "RTL8812AU" /* TRENDnet */
++0x0000 0x0000 0x2357 0x0101    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2357 0x0103    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2357 0x010d    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2357 0x010e    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2357 0x010f    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2357 0x0122    0      0  "Realtek" "RTL8812AU" /* TP-Link */
++0x0000 0x0000 0x2604 0x0012    0      0  "Realtek" "RTL8812AU" /* Tenda */
++0x0000 0x0000 0x7392 0xa822    0      0  "Realtek" "RTL8812AU" /* Edimax */
++# rtw88/rtw8814au.c
++0x0000 0x0000 0x056e 0x400b    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x056e 0x400d    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x0846 0x9054    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x0b05 0x1817    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x0b05 0x1852    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x0b05 0x1853    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x0e66 0x0026    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x2001 0x331a    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x20f4 0x809a    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x20f4 0x809b    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x2357 0x0106    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x7392 0xa834    0      0  "Realtek" "RTL8814AU"
++0x0000 0x0000 0x7392 0xa833    0      0  "Realtek" "RTL8814AU"
++# rtw88/rtw8821au.c
++0x0000 0x0000 0x0411 0x0242    0      0  "Realtek" "RTL8821AU" /* Buffalo */
++0x0000 0x0000 0x0411 0x029b    0      0  "Realtek" "RTL8821AU" /* Buffalo */
++0x0000 0x0000 0x04bb 0x0953    0      0  "Realtek" "RTL8821AU" /* I-O DATA */
++0x0000 0x0000 0x056e 0x4007    0      0  "Realtek" "RTL8821AU" /* ELECOM */
++0x0000 0x0000 0x056e 0x400e    0      0  "Realtek" "RTL8821AU" /* ELECOM */
++0x0000 0x0000 0x056e 0x400f    0      0  "Realtek" "RTL8821AU" /* ELECOM */
++0x0000 0x0000 0x0846 0x9052    0      0  "Realtek" "RTL8821AU" /* Netgear */
++0x0000 0x0000 0x0e66 0x0023    0      0  "Realtek" "RTL8821AU" /* HAWKING */
++0x0000 0x0000 0x2001 0x3314    0      0  "Realtek" "RTL8821AU" /* D-Link */
++0x0000 0x0000 0x2001 0x3318    0      0  "Realtek" "RTL8821AU" /* D-Link */
++0x0000 0x0000 0x2019 0xab32    0      0  "Realtek" "RTL8821AU" /* Planex */
++0x0000 0x0000 0x20f4 0x804b    0      0  "Realtek" "RTL8821AU" /* TRENDnet */
++0x0000 0x0000 0x2357 0x011e    0      0  "Realtek" "RTL8821AU" /* TP Link */
++0x0000 0x0000 0x2357 0x011f    0      0  "Realtek" "RTL8821AU" /* TP Link */
++0x0000 0x0000 0x2357 0x0120    0      0  "Realtek" "RTL8821AU" /* TP Link */
++0x0000 0x0000 0x3823 0x6249    0      0  "Realtek" "RTL8821AU" /* Obihai */
++0x0000 0x0000 0x7392 0xa811    0      0  "Realtek" "RTL8821AU" /* Edimax */
++0x0000 0x0000 0x7392 0xa812    0      0  "Realtek" "RTL8821AU" /* Edimax */
++0x0000 0x0000 0x7392 0xa813    0      0  "Realtek" "RTL8821AU" /* Edimax */
++0x0000 0x0000 0x7392 0xb611    0      0  "Realtek" "RTL8821AU" /* Edimax */
++0x0000 0x0000 0x0bda 0x0811    0      0  "Realtek" "RTL8821AU" /* Alfa AWUS036ACS */
++# rtw88/rtw8821cu.c
++0x0000 0x0000 0x2001 0x331d    0      0  "Realtek" "RTL8821CU" /* D-Link */
++0x0000 0x0000 0x7392 0xc811    0      0  "Realtek" "RTL8821CU" /* Edimax */
++0x0000 0x0000 0x7392 0xd811    0      0  "Realtek" "RTL8821CU" /* Edimax */
++0x0000 0x0000 0x0bda 0xc820    0      0  "Realtek" "RTL8821CU"
++# rtw88/rtw8822bu.c
++0x0000 0x0000 0x7392 0xb822    0      0  "Realtek" "RTL8822BU" /* Edimax EW-7822ULC */
++0x0000 0x0000 0x7392 0xc822    0      0  "Realtek" "RTL8822BU" /* Edimax EW-7822UTC */
++0x0000 0x0000 0x7392 0xd822    0      0  "Realtek" "RTL8822BU" /* Edimax */
++0x0000 0x0000 0x7392 0xe822    0      0  "Realtek" "RTL8822BU" /* Edimax */
++0x0000 0x0000 0x7392 0xf822    0      0  "Realtek" "RTL8822BU" /* Edimax EW-7822UAD */
++0x0000 0x0000 0x0b05 0x1841    0      0  "Realtek" "RTL8822BU" /* ASUS AC1300 USB-AC55 B1 */
++0x0000 0x0000 0x0b05 0x184c    0      0  "Realtek" "RTL8822BU" /* ASUS U2 */
++0x0000 0x0000 0x0B05 0x19aa    0      0  "Realtek" "RTL8822BU" /* ASUS - USB-AC58 rev A1 */
++0x0000 0x0000 0x0B05 0x1870    0      0  "Realtek" "RTL8822BU" /* ASUS */
++0x0000 0x0000 0x0B05 0x1874    0      0  "Realtek" "RTL8822BU" /* ASUS */
++0x0000 0x0000 0x2001 0x331e    0      0  "Realtek" "RTL8822BU" /* Dlink - DWA-181 */
++0x0000 0x0000 0x2001 0x331c    0      0  "Realtek" "RTL8822BU" /* Dlink - DWA-182 - D1 */
++0x0000 0x0000 0x2001 0x331f    0      0  "Realtek" "RTL8822BU" /* Dlink - DWA-183 D Ver */
++0x0000 0x0000 0x13b1 0x0043    0      0  "Realtek" "RTL8822BU" /* Linksys WUSB6400M */
++0x0000 0x0000 0x13b1 0x0045    0      0  "Realtek" "RTL8822BU" /* Linksys WUSB3600 v2 */
++0x0000 0x0000 0x2357 0x012d    0      0  "Realtek" "RTL8822BU" /* TP-Link Archer T3U v1 */
++0x0000 0x0000 0x2357 0x0138    0      0  "Realtek" "RTL8822BU" /* TP-Link Archer T3U Plus v1 */
++0x0000 0x0000 0x2357 0x0115    0      0  "Realtek" "RTL8822BU" /* TP-Link Archer T4U V3 */
++0x0000 0x0000 0x2357 0x012e    0      0  "Realtek" "RTL8822BU" /* TP-LINK */
++0x0000 0x0000 0x2357 0x0116    0      0  "Realtek" "RTL8822BU" /* TP-LINK */
++0x0000 0x0000 0x2357 0x0117    0      0  "Realtek" "RTL8822BU" /* TP-LINK */
++0x0000 0x0000 0x0846 0x9055    0      0  "Realtek" "RTL8822BU" /* Netgear A6150 */
++0x0000 0x0000 0x0e66 0x0025    0      0  "Realtek" "RTL8822BU" /* Hawking HW12ACU */
++0x0000 0x0000 0x04ca 0x8602    0      0  "Realtek" "RTL8822BU" /* LiteOn */
++0x0000 0x0000 0x20f4 0x808a    0      0  "Realtek" "RTL8822BU" /* TRENDnet TEW-808UBM */
++0x0000 0x0000 0x20f4 0x805a    0      0  "Realtek" "RTL8822BU" /* TRENDnet TEW-805UBH */
++0x0000 0x0000 0x056e 0x4011    0      0  "Realtek" "RTL8822BU" /* ELECOM WDB-867DU3S */
++0x0000 0x0000 0x2c4e 0x0107    0      0  "Realtek" "RTL8822BU" /* Mercusys MA30H */
++0x0000 0x0000 0x2c4e 0x010a    0      0  "Realtek" "RTL8822BU" /* Mercusys MA30N */
++0x0000 0x0000 0x2001 0x3322    0      0  "Realtek" "RTL8822BU" /* D-Link DWA-T185 rev. A1 */
++0x0000 0x0000 0x0411 0x03d1    0      0  "Realtek" "RTL8822BU" /* BUFFALO WI-U2-866DM */
++# rtw88/rtw8822cu.c
++0x0000 0x0000 0x13b1 0x0043    0      0  "Realtek" "RTL8822CU" /* Alpha - Alpha */
++#####
++0x02d0 0x4356 0x0000 0x0000    0      0  "Broadcom" "BCM4356"
++0x02d0 0xa9bf 0x0000 0x0000    0      0  "Broadcom" "BCM43456"
++0x14c3 0x7922 0x1A3B 0x5300    0      0  "MediaTek" "MT7922"
++0x10ec 0x8852 0x1e26 0x007f    0      0  "Realtek" "RTL8852AE"
+ 
+ # FDT compatible strings
+ # "compatible" | txpower offset | frequency offset | ...
-- 
2.51.0
